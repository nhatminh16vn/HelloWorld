<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Game Đuổi Bắt</title>
<style>
  body {
    margin: 0; background: #111; color: #eee; font-family: Arial, sans-serif;
    display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;
  }
  #gameCanvas {
    background: #222;
    border: 2px solid #555;
    display: block;
  }
  #info {
    margin-top: 10px;
    font-size: 20px;
    display: flex;
    gap: 15px;
    align-items: center;
  }
  #buttonsContainer {
    margin-top: 15px;
    display: none;
    gap: 10px;
  }
  button {
    font-size: 18px;
    padding: 8px 16px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    background: #44aaff;
    color: white;
    transition: background 0.3s;
  }
  button:hover {
    background: #2288dd;
  }
  #startBtn {
    margin-top: 15px;
    font-size: 20px;
    padding: 10px 20px;
    background: #22cc88;
  }
  #startBtn:hover {
    background: #1aa76a;
  }
</style>
</head>
<body>

<canvas id="gameCanvas" width="600" height="400"></canvas>

<div id="info">
  Thời gian sống sót: <span id="timer">0.0</span> giây
  <span> | Điểm cao nhất: <span id="highscore">0.0</span></span>
</div>

<button id="startBtn">Bắt đầu</button>

<div id="buttonsContainer">
  <button id="restartBtn">Chơi lại</button>
  <button id="exitBtn">Thoát</button>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const player = {
  x: 50,
  y: 50,
  size: 30,
  speed: 5,
  color: 'cyan',
};

const chasers = [
  { x: 500, y: 300, size: 30, baseSpeed: 2.5, speed: 2.5, color: 'red', phase: 0 },
];

let keys = {};
let startTime = null;
let gameOver = false;
let highScore = parseFloat(localStorage.getItem('chaseHighScore')) || 0;
document.getElementById('highscore').textContent = highScore.toFixed(1);

let lastAddTime = 0;
let running = false;

const startBtn = document.getElementById('startBtn');
const buttonsContainer = document.getElementById('buttonsContainer');
const restartBtn = document.getElementById('restartBtn');
const exitBtn = document.getElementById('exitBtn');

window.addEventListener('keydown', e => {
  if (running) keys[e.key.toLowerCase()] = true;
});
window.addEventListener('keyup', e => {
  if (running) keys[e.key.toLowerCase()] = false;
});

function movePlayer() {
  if (keys['w'] || keys['arrowup']) player.y -= player.speed;
  if (keys['s'] || keys['arrowdown']) player.y += player.speed;
  if (keys['a'] || keys['arrowleft']) player.x -= player.speed;
  if (keys['d'] || keys['arrowright']) player.x += player.speed;

  player.x = Math.max(0, Math.min(player.x, canvas.width - player.size));
  player.y = Math.max(0, Math.min(player.y, canvas.height - player.size));
}

function moveChaser(chaser, elapsed) {
  chaser.speed = chaser.baseSpeed + elapsed * 0.12;

  let dx = player.x - chaser.x;
  let dy = player.y - chaser.y;
  let dist = Math.sqrt(dx * dx + dy * dy);

  if (dist > 0) {
    chaser.x += (dx / dist) * chaser.speed;
    chaser.y += (dy / dist) * chaser.speed;
  }
}

function checkCollision(obj1, obj2) {
  return !(
    obj1.x + obj1.size < obj2.x ||
    obj1.x > obj2.x + obj2.size ||
    obj1.y + obj1.size < obj2.y ||
    obj1.y > obj2.y + obj2.size
  );
}

function updateTimer() {
  if (!startTime) startTime = Date.now();
  let elapsed = (Date.now() - startTime) / 1000;
  document.getElementById('timer').textContent = elapsed.toFixed(1);
  return elapsed;
}

function drawRect(obj) {
  ctx.fillStyle = obj.color;
  ctx.fillRect(obj.x, obj.y, obj.size, obj.size);
}

function createNewChaser() {
  const size = 30;
  let x = Math.random() * (canvas.width - size);
  let y = Math.random() * (canvas.height - size);
  let baseSpeed = 1.5 + Math.random() * 1.5;
  const colors = ['red', 'orange', 'yellow', 'lime', 'cyan', 'magenta'];
  let color = colors[Math.floor(Math.random() * colors.length)];

  return { x, y, size, baseSpeed, speed: baseSpeed, color, phase: Math.random() * Math.PI * 2 };
}

function resetGame() {
  player.x = 50;
  player.y = 50;
  chasers.length = 0;
  chasers.push({ x: 500, y: 300, size: 30, baseSpeed: 2.5, speed: 2.5, color: 'red', phase: 0 });
  startTime = null;
  gameOver = false;
  lastAddTime = 0;
  keys = {};
  buttonsContainer.style.display = 'none';
  startBtn.style.display = 'none';
}

function gameLoop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (gameOver) {
    ctx.fillStyle = '#44aaff';
    ctx.font = '48px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Bạn đã bị bắt!', canvas.width / 2, canvas.height / 2 - 20);
    ctx.font = '24px Arial';
    ctx.fillText('Chọn Chơi lại hoặc Thoát', canvas.width / 2, canvas.height / 2 + 20);

    buttonsContainer.style.display = 'flex';
    running = false;

    requestAnimationFrame(gameLoop);
    return;
  }

  movePlayer();

  let elapsed = updateTimer();

  if (elapsed - lastAddTime >= 1) {
    chasers.push(createNewChaser());
    lastAddTime = elapsed;
  }

  for (let chaser of chasers) {
    moveChaser(chaser, elapsed);
    drawRect(chaser);

    if (checkCollision(player, chaser)) {
      gameOver = true;
      if (elapsed > highScore) {
        highScore = elapsed;
        localStorage.setItem('chaseHighScore', highScore.toFixed(1));
        document.getElementById('highscore').textContent = highScore.toFixed(1);
      }
    }
  }

  drawRect(player);

  if (!gameOver) requestAnimationFrame(gameLoop);
}

startBtn.addEventListener('click', () => {
  resetGame();
  running = true;
  gameLoop();
});

restartBtn.addEventListener('click', () => {
  resetGame();
  running = true;
  gameLoop();
});

exitBtn.addEventListener('click', () => {
  running = false;
  buttonsContainer.style.display = 'none';
  startBtn.style.display = 'inline-block';
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#44aaff';
  ctx.font = '36px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('Cảm ơn bạn đã chơi!', canvas.width / 2, canvas.height / 2);
});
</script>

</body>
</html>
