<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>11 Bot vs 11 Bot Football</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #87CEEB;
            font-family: Arial, sans-serif;
        }
        canvas { 
            display: block; 
        }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 18px;
            text-shadow: 1px 1px 1px black;
        }
        #score {
            position: absolute;
            top: 40px;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 24px;
            text-shadow: 1px 1px 1px black;
        }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            background-color: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="info">11 Bot vs 11 Bot Football Simulation</div>
    <div id="score">Team A: 0 - Team B: 0</div>
    <div id="controls">
        <p>Controls:</p>
        <p>R: Reset simulation</p>
        <p>P: Pause/Resume</p>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script>
        // Khởi tạo scene, camera và renderer
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Khởi tạo vật lý với Cannon.js
        const world = new CANNON.World();
        world.gravity.set(0, -9.82, 0);
        world.broadphase = new CANNON.NaiveBroadphase();
        world.solver.iterations = 10;

        // Tạo sân bóng lớn hơn
        const pitchWidth = 60;
        const pitchHeight = 40;
        const groundGeometry = new THREE.PlaneGeometry(pitchWidth, pitchHeight);
        const groundMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x00AA00,
            side: THREE.DoubleSide
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Vật lý cho mặt đất
        const groundShape = new CANNON.Plane();
        const groundBody = new CANNON.Body({ mass: 0 });
        groundBody.addShape(groundShape);
        groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
        world.addBody(groundBody);

        // Tạo đường giữa sân
        const lineGeometry = new THREE.BoxGeometry(0.5, 0.1, pitchHeight);
        const lineMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFFFF });
        const line = new THREE.Mesh(lineGeometry, lineMaterial);
        line.position.set(0, 0.1, 0);
        scene.add(line);

        // Tạo vòng tròn giữa sân
        const circleGeometry = new THREE.TorusGeometry(5, 0.2, 16, 32);
        const circleMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFFFF });
        const circle = new THREE.Mesh(circleGeometry, circleMaterial);
        circle.rotation.x = -Math.PI / 2;
        circle.position.set(0, 0.1, 0);
        scene.add(circle);

        // Tạo khung thành
        function createGoal(x, z, color) {
            // Khung thành chính
            const goalGeometry = new THREE.BoxGeometry(3, 2.5, 2);
            const goalMaterial = new THREE.MeshStandardMaterial({ 
                color: color,
                transparent: true,
                opacity: 0.7
            });
            const goal = new THREE.Mesh(goalGeometry, goalMaterial);
            goal.position.set(x, 1.25, z);
            goal.castShadow = true;
            scene.add(goal);
            
            // Cột dọc
            const postGeometry = new THREE.CylinderGeometry(0.15, 0.15, 3, 16);
            const postMaterial = new THREE.MeshStandardMaterial({ color: 0xFFFFFF });
            
            // 2 cột dọc
            const leftPost = new THREE.Mesh(postGeometry, postMaterial);
            leftPost.position.set(x, 1.5, z - 1);
            scene.add(leftPost);
            
            const rightPost = new THREE.Mesh(postGeometry, postMaterial);
            rightPost.position.set(x, 1.5, z + 1);
            scene.add(rightPost);
            
            // Xà ngang
            const crossbarGeometry = new THREE.BoxGeometry(0.3, 0.3, 2);
            const crossbar = new THREE.Mesh(crossbarGeometry, postMaterial);
            crossbar.position.set(x, 3, z);
            scene.add(crossbar);
            
            // Vật lý cho khung thành
            const goalShape = new CANNON.Box(new CANNON.Vec3(1.5, 1.25, 1));
            const goalBody = new CANNON.Body({ mass: 0 });
            goalBody.addShape(goalShape);
            goalBody.position.set(x, 1.25, z);
            world.addBody(goalBody);
            
            return { goal, goalBody };
        }

        // Khung thành Team A (màu xanh)
        const teamAGoal = createGoal(-pitchWidth/2, 0, 0x0000FF);
        // Khung thành Team B (màu đỏ)
        const teamBGoal = createGoal(pitchWidth/2, 0, 0xFF0000);

        // Tạo bóng
        const ballGeometry = new THREE.SphereGeometry(0.5, 32, 32);
        const ballMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xFFFFFF,
            roughness: 0.1,
            metalness: 0.3
        });
        const ball = new THREE.Mesh(ballGeometry, ballMaterial);
        ball.position.set(0, 2, 0);
        ball.castShadow = true;
        scene.add(ball);

        // Vật lý cho bóng
        const ballShape = new CANNON.Sphere(0.5);
        const ballBody = new CANNON.Body({ mass: 0.5 });
        ballBody.addShape(ballShape);
        ballBody.position.set(0, 2, 0);
        ballBody.linearDamping = 0.4;
        ballBody.angularDamping = 0.4;
        world.addBody(ballBody);

        // Tạo cầu thủ
        function createPlayer(x, z, color, team) {
            const playerGeometry = new THREE.CylinderGeometry(0.4, 0.4, 1.5, 16);
            const playerMaterial = new THREE.MeshStandardMaterial({ color: color });
            const player = new THREE.Mesh(playerGeometry, playerMaterial);
            player.position.set(x, 0.75, z);
            player.castShadow = true;
            scene.add(player);

            // Vật lý cho cầu thủ
            const playerShape = new CANNON.Cylinder(0.4, 0.4, 1.5, 16);
            const playerBody = new CANNON.Body({ mass: 5 });
            playerBody.addShape(playerShape);
            playerBody.position.set(x, 0.75, z);
            playerBody.linearDamping = 0.5;
            playerBody.angularDamping = 0.5;
            playerBody.team = team; // Thêm thuộc tính team
            world.addBody(playerBody);
            
            return { player, playerBody };
        }

        // Tạo đội hình 4-4-2 cho cả 2 đội
        const teamAPlayers = [];
        const teamBPlayers = [];
        
        // Team A (Blue - playing from left to right)
        // Goalkeeper
        teamAPlayers.push(createPlayer(-pitchWidth/2 + 3, 0, 0x0000FF, 'A'));
        
        // Defenders (4)
        teamAPlayers.push(createPlayer(-pitchWidth/2 + 10, -8, 0x0000FF, 'A'));
        teamAPlayers.push(createPlayer(-pitchWidth/2 + 10, 8, 0x0000FF, 'A'));
        teamAPlayers.push(createPlayer(-pitchWidth/2 + 10, -4, 0x0000FF, 'A'));
        teamAPlayers.push(createPlayer(-pitchWidth/2 + 10, 4, 0x0000FF, 'A'));
        
        // Midfielders (4)
        teamAPlayers.push(createPlayer(-pitchWidth/4, -10, 0x0000FF, 'A'));
        teamAPlayers.push(createPlayer(-pitchWidth/4, 10, 0x0000FF, 'A'));
        teamAPlayers.push(createPlayer(-pitchWidth/4, -5, 0x0000FF, 'A'));
        teamAPlayers.push(createPlayer(-pitchWidth/4, 5, 0x0000FF, 'A'));
        
        // Forwards (2)
        teamAPlayers.push(createPlayer(-5, -3, 0x0000FF, 'A'));
        teamAPlayers.push(createPlayer(-5, 3, 0x0000FF, 'A'));

        // Team B (Red - playing from right to left)
        // Goalkeeper
        teamBPlayers.push(createPlayer(pitchWidth/2 - 3, 0, 0xFF0000, 'B'));
        
        // Defenders (4)
        teamBPlayers.push(createPlayer(pitchWidth/2 - 10, -8, 0xFF0000, 'B'));
        teamBPlayers.push(createPlayer(pitchWidth/2 - 10, 8, 0xFF0000, 'B'));
        teamBPlayers.push(createPlayer(pitchWidth/2 - 10, -4, 0xFF0000, 'B'));
        teamBPlayers.push(createPlayer(pitchWidth/2 - 10, 4, 0xFF0000, 'B'));
        
        // Midfielders (4)
        teamBPlayers.push(createPlayer(pitchWidth/4, -10, 0xFF0000, 'B'));
        teamBPlayers.push(createPlayer(pitchWidth/4, 10, 0xFF0000, 'B'));
        teamBPlayers.push(createPlayer(pitchWidth/4, -5, 0xFF0000, 'B'));
        teamBPlayers.push(createPlayer(pitchWidth/4, 5, 0xFF0000, 'B'));
        
        // Forwards (2)
        teamBPlayers.push(createPlayer(5, -3, 0xFF0000, 'B'));
        teamBPlayers.push(createPlayer(5, 3, 0xFF0000, 'B'));

        // Ánh sáng
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xFFFFFF, 0.8);
        directionalLight.position.set(10, 20, 10);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        scene.add(directionalLight);

        // Đặt camera
        camera.position.set(0, 40, 40);
        camera.lookAt(0, 0, 0);

        // Điều khiển
        const keys = {};
        document.addEventListener('keydown', (event) => {
            keys[event.code] = true;
            
            // Reset game
            if (event.code === 'KeyR') {
                resetGame();
            }
            
            // Pause game
            if (event.code === 'KeyP') {
                paused = !paused;
            }
        });

        // Biến điểm
        let teamAScore = 0;
        let teamBScore = 0;
        const scoreElement = document.getElementById('score');
        let paused = false;

        // AI cho các cầu thủ
        function updatePlayersAI() {
            const ballPos = ballBody.position;
            
            // Cập nhật AI cho Team A
            teamAPlayers.forEach((playerObj, index) => {
                const playerBody = playerObj.playerBody;
                const playerPos = playerBody.position;
                
                // Mục tiêu mặc định là vị trí đội hình
                let targetPos = new CANNON.Vec3();
                
                // Thủ môn
                if (index === 0) {
                    // Thủ môn di chuyển theo bóng nhưng giữ khoảng cách với khung thành
                    targetPos.set(
                        -pitchWidth/2 + 3,
                        0.75,
                        ballPos.z * 0.3 // Di chuyển theo bóng nhưng không quá xa
                    );
                    
                    // Nếu bóng gần thì cố gắng cản phá
                    if (playerPos.distanceTo(ballPos) < 5 && ballPos.x < -pitchWidth/2 + 10) {
                        const direction = new CANNON.Vec3();
                        direction.set(ballPos.x - playerPos.x, 0, ballPos.z - playerPos.z);
                        direction.normalize();
                        playerBody.velocity.x = direction.x * 8;
                        playerBody.velocity.z = direction.z * 8;
                        
                        // Nếu đủ gần thì đẩy bóng ra
                        if (playerPos.distanceTo(ballPos) < 2) {
                            const kickDirection = new CANNON.Vec3(1, 0.2, (Math.random() - 0.5) * 0.5);
                            kickDirection.normalize();
                            kickDirection.scale(15, kickDirection);
                            ballBody.velocity.copy(kickDirection);
                        }
                        return;
                    }
                }
                // Hậu vệ
                else if (index < 5) {
                    // Hậu vệ phòng thủ khu vực của mình
                    const baseX = -pitchWidth/2 + 10;
                    const baseZ = [-8, 8, -4, 4][index - 1];
                    
                    // Nếu bóng ở phía sân nhà thì áp sát
                    if (ballPos.x < 0) {
                        // Tính vị trí giữa bóng và vị trí phòng ngự
                        targetPos.set(
                            baseX + (ballPos.x - baseX) * 0.5,
                            0.75,
                            baseZ + (ballPos.z - baseZ) * 0.5
                        );
                    } else {
                        // Lui về vị trí phòng ngự
                        targetPos.set(baseX, 0.75, baseZ);
                    }
                }
                // Tiền vệ
                else if (index < 9) {
                    // Tiền vệ di chuyển theo bóng nhưng giữ vị trí tương đối
                    const baseX = -pitchWidth/4;
                    const baseZ = [-10, 10, -5, 5][index - 5];
                    
                    targetPos.set(
                        baseX + (ballPos.x - baseX) * 0.3,
                        0.75,
                        baseZ + (ballPos.z - baseZ) * 0.3
                    );
                }
                // Tiền đạo
                else {
                    // Tiền đạo tấn công khi bóng ở phía đối phương
                    if (ballPos.x > 0) {
                        targetPos.set(
                            ballPos.x * 0.7,
                            0.75,
                            ballPos.z * 0.7
                        );
                    } else {
                        // Lui về vị trí đợi bóng
                        targetPos.set(-5, 0.75, [-3, 3][index - 9]);
                    }
                }
                
                // Di chuyển đến vị trí mục tiêu
                const direction = new CANNON.Vec3();
                direction.set(targetPos.x - playerPos.x, 0, targetPos.z - playerPos.z);
                direction.normalize();
                
                const speed = index === 0 ? 5 : 4; // Thủ môn di chuyển nhanh hơn
                playerBody.velocity.x = direction.x * speed;
                playerBody.velocity.z = direction.z * speed;
                
                // Nếu gần bóng thì sút hoặc tranh bóng
                if (playerPos.distanceTo(ballPos) < 2) {
                    if (Math.random() < 0.1) { // 10% cơ hội sút bóng
                        const kickDirection = new CANNON.Vec3(
                            1 + (Math.random() - 0.5) * 0.3,
                            0.2,
                            (Math.random() - 0.5) * 0.5
                        );
                        kickDirection.normalize();
                        kickDirection.scale(15 + Math.random() * 10, kickDirection);
                        ballBody.velocity.copy(kickDirection);
                    }
                }
            });
            
            // Cập nhật AI cho Team B (tương tự nhưng ngược lại)
            teamBPlayers.forEach((playerObj, index) => {
                const playerBody = playerObj.playerBody;
                const playerPos = playerBody.position;
                
                let targetPos = new CANNON.Vec3();
                
                // Thủ môn
                if (index === 0) {
                    targetPos.set(
                        pitchWidth/2 - 3,
                        0.75,
                        ballPos.z * 0.3
                    );
                    
                    if (playerPos.distanceTo(ballPos) < 5 && ballPos.x > pitchWidth/2 - 10) {
                        const direction = new CANNON.Vec3();
                        direction.set(ballPos.x - playerPos.x, 0, ballPos.z - playerPos.z);
                        direction.normalize();
                        playerBody.velocity.x = direction.x * 8;
                        playerBody.velocity.z = direction.z * 8;
                        
                        if (playerPos.distanceTo(ballPos) < 2) {
                            const kickDirection = new CANNON.Vec3(-1, 0.2, (Math.random() - 0.5) * 0.5);
                            kickDirection.normalize();
                            kickDirection.scale(15, kickDirection);
                            ballBody.velocity.copy(kickDirection);
                        }
                        return;
                    }
                }
                // Hậu vệ
                else if (index < 5) {
                    const baseX = pitchWidth/2 - 10;
                    const baseZ = [-8, 8, -4, 4][index - 1];
                    
                    if (ballPos.x > 0) {
                        targetPos.set(
                            baseX + (ballPos.x - baseX) * 0.5,
                            0.75,
                            baseZ + (ballPos.z - baseZ) * 0.5
                        );
                    } else {
                        targetPos.set(baseX, 0.75, baseZ);
                    }
                }
                // Tiền vệ
                else if (index < 9) {
                    const baseX = pitchWidth/4;
                    const baseZ = [-10, 10, -5, 5][index - 5];
                    
                    targetPos.set(
                        baseX + (ballPos.x - baseX) * 0.3,
                        0.75,
                        baseZ + (ballPos.z - baseZ) * 0.3
                    );
                }
                // Tiền đạo
                else {
                    if (ballPos.x < 0) {
                        targetPos.set(
                            ballPos.x * 0.7,
                            0.75,
                            ballPos.z * 0.7
                        );
                    } else {
                        targetPos.set(5, 0.75, [-3, 3][index - 9]);
                    }
                }
                
                const direction = new CANNON.Vec3();
                direction.set(targetPos.x - playerPos.x, 0, targetPos.z - playerPos.z);
                direction.normalize();
                
                const speed = index === 0 ? 5 : 4;
                playerBody.velocity.x = direction.x * speed;
                playerBody.velocity.z = direction.z * speed;
                
                if (playerPos.distanceTo(ballPos) < 2) {
                    if (Math.random() < 0.1) {
                        const kickDirection = new CANNON.Vec3(
                            -1 + (Math.random() - 0.5) * 0.3,
                            0.2,
                            (Math.random() - 0.5) * 0.5
                        );
                        kickDirection.normalize();
                        kickDirection.scale(15 + Math.random() * 10, kickDirection);
                        ballBody.velocity.copy(kickDirection);
                    }
                }
            });
        }

        // Reset bóng về vị trí trung tâm
        function resetBall() {
            ballBody.position.set(0, 2, 0);
            ballBody.velocity.set(0, 0, 0);
            ballBody.angularVelocity.set(0, 0, 0);
        }

        // Reset toàn bộ game
        function resetGame() {
            teamAScore = 0;
            teamBScore = 0;
            scoreElement.textContent = `Team A: ${teamAScore} - Team B: ${teamBScore}`;
            resetBall();
            
            // Reset vị trí cầu thủ Team A
            teamAPlayers.forEach((playerObj, index) => {
                const playerBody = playerObj.playerBody;
                
                // Goalkeeper
                if (index === 0) {
                    playerBody.position.set(-pitchWidth/2 + 3, 0.75, 0);
                }
                // Defenders (4)
                else if (index < 5) {
                    const zPos = [-8, 8, -4, 4][index - 1];
                    playerBody.position.set(-pitchWidth/2 + 10, 0.75, zPos);
                }
                // Midfielders (4)
                else if (index < 9) {
                    const zPos = [-10, 10, -5, 5][index - 5];
                    playerBody.position.set(-pitchWidth/4, 0.75, zPos);
                }
                // Forwards (2)
                else {
                    const zPos = [-3, 3][index - 9];
                    playerBody.position.set(-5, 0.75, zPos);
                }
                
                playerBody.velocity.set(0, 0, 0);
                playerBody.angularVelocity.set(0, 0, 0);
            });
            
            // Reset vị trí cầu thủ Team B
            teamBPlayers.forEach((playerObj, index) => {
                const playerBody = playerObj.playerBody;
                
                // Goalkeeper
                if (index === 0) {
                    playerBody.position.set(pitchWidth/2 - 3, 0.75, 0);
                }
                // Defenders (4)
                else if (index < 5) {
                    const zPos = [-8, 8, -4, 4][index - 1];
                    playerBody.position.set(pitchWidth/2 - 10, 0.75, zPos);
                }
                // Midfielders (4)
                else if (index < 9) {
                    const zPos = [-10, 10, -5, 5][index - 5];
                    playerBody.position.set(pitchWidth/4, 0.75, zPos);
                }
                // Forwards (2)
                else {
                    const zPos = [-3, 3][index - 9];
                    playerBody.position.set(5, 0.75, zPos);
                }
                
                playerBody.velocity.set(0, 0, 0);
                playerBody.angularVelocity.set(0, 0, 0);
            });
        }

        // Vòng lặp game
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            
            if (paused) return;
            
            const delta = clock.getDelta();
            world.step(delta);
            
            // Cập nhật vị trí đồ họa từ vật lý
            ball.position.copy(ballBody.position);
            ball.quaternion.copy(ballBody.quaternion);
            
            teamAPlayers.forEach(playerObj => {
                playerObj.player.position.copy(playerObj.playerBody.position);
                playerObj.player.quaternion.copy(playerObj.playerBody.quaternion);
            });
            
            teamBPlayers.forEach(playerObj => {
                playerObj.player.position.copy(playerObj.playerBody.position);
                playerObj.player.quaternion.copy(playerObj.playerBody.quaternion);
            });
            
            // Cập nhật AI cho các cầu thủ
            updatePlayersAI();
            
            // Kiểm tra ghi bàn
            const ballPos = ballBody.position;
            
            // Team A ghi bàn (bóng vào khung thành Team B)
            if (ballPos.x > pitchWidth/2 - 1.5 && ballPos.z > -1 && ballPos.z < 1) {
                teamAScore++;
                scoreElement.textContent = `Team A: ${teamAScore} - Team B: ${teamBScore}`;
                resetBall();
            }
            
            // Team B ghi bàn (bóng vào khung thành Team A)
            if (ballPos.x < -pitchWidth/2 + 1.5 && ballPos.z > -1 && ballPos.z < 1) {
                teamBScore++;
                scoreElement.textContent = `Team A: ${teamAScore} - Team B: ${teamBScore}`;
                resetBall();
            }
            
            renderer.render(scene, camera);
        }

        // Xử lý thay đổi kích thước cửa sổ
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        resetGame();
        animate();
    </script>
</body>
</html>
